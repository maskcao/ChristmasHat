<!DOCTYPE html>
<!--
åç§°ï¼šç»™ä½ çš„å¤´åƒåŠ ä¸Šåœ£è¯å¸½
åˆ¶ä½œï¼šè•Šè•Š
Q Q ï¼š1612704618
-->
<html lang='zh-CN'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>ç»™ä½ çš„å¤´åƒåŠ ä¸Šåœ£è¯å¸½</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", sans-serif;
    }
    body {
      font-size: 16px;
      background-color: #1a1a1a;
      padding: 20px;
      color: #fff;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    .page-title {
      font-size: 24px;
      text-align: center;
      margin-bottom: 30px;
      color: #ff9900;
      text-shadow: 0 0 8px rgba(255,153,0,0.6);
    }
    .section {
      background-color: #2d2d2d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .section-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ffcc66;
      display: flex;
      align-items: center;
    }
    .section-title::before {
      content: "ğŸ„";
      margin-right: 8px;
    }
    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 20px 0;
    }
    .upload-btn {
      background-color: #3d3d3d;
      border: 1px dashed #666;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-btn:hover {
      border-color: #ff9900;
      background-color: #444;
    }
    #upload {
      display: none;
    }
    .select-img-btn {
      background-color: #ff9900;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      color: #1a1a1a;
      font-weight: 600;
    }
    .select-img-btn:hover {
      background-color: #ffcc66;
      transform: translateY(-2px);
    }
    /* åœ£è¯å¸½é€‰æ‹©æ  */
    .hat-list {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 10px 0;
      scrollbar-width: thin;
      scrollbar-color: #ff9900 #3d3d3d;
    }
    .hat-list::-webkit-scrollbar {
      height: 6px;
    }
    .hat-list::-webkit-scrollbar-thumb {
      background-color: #ff9900;
      border-radius: 3px;
    }
    .hat-item {
      width: 85px;
      height: 85px;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background-color: #333;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hat-item.active {
      border-color: #ff9900;
      box-shadow: 0 0 10px rgba(255,153,0,0.5);
    }
    .hat-item:hover {
      border-color: #ffcc66;
      transform: scale(1.05);
    }
    .hat-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* ç”»å¸ƒåŒºåŸŸ */
    .canvas-wrap {
      margin: 20px 0;
      display: none;
      text-align: center;
    }
    #cvs {
      max-width: 100%;
      border: 1px solid #444;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    /* å¯¼å‡ºåŒºåŸŸ */
    #export {
      display: none; /* éšè—æ‰‹åŠ¨ä¿å­˜çš„å›¾ç‰‡ï¼Œæ”¹ä¸ºè‡ªåŠ¨ä¸‹è½½ */
      max-width: 300px;
      margin: 20px auto;
      border: 1px solid #444;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
    .btn-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 10px;
    }
    .btn {
      padding: 12px 28px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-weight: 600;
    }
    .change-btn {
      background-color: #3d3d3d;
      color: #ffcc66;
    }
    .change-btn:hover {
      background-color: #444;
      transform: translateY(-2px);
    }
    .export-btn {
      background-color: #ff9900;
      color: #1a1a1a;
    }
    .export-btn:hover {
      background-color: #ffcc66;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: none;
    }
    /* æç¤ºæ–‡å­— */
    #tip {
      margin-top: 12px;
      font-size: 14px;
      color: #999;
      opacity: 0.8;
    }
    /* åº•éƒ¨æç¤º */
    .footer-tip {
      font-size: 14px;
      color: #888;
      margin-top: 30px;
      text-align: center;
      line-height: 1.8;
    }
    .footer-link {
      color: #ff9900;
      text-decoration: none;
      transition: color 0.3s;
    }
    .footer-link:hover {
      color: #ffcc66;
      text-decoration: underline;
    }
    /* å›¾ç‰‡åŠ è½½å¤±è´¥æç¤º */
    .hat-loading {
      font-size: 12px;
      color: #999;
    }
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 375px) {
      .upload-area {
        flex-direction: column;
        gap: 10px;
      }
      .btn-group {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">ç»™ä½ çš„å¤´åƒåŠ ä¸Šåœ£è¯å¸½</h1>

    <!-- é€‰æ‹©å›¾ç‰‡åŒºåŸŸ -->
    <div class="section">
      <h3 class="section-title">é€‰æ‹©è¦åˆ¶ä½œçš„å›¾ç‰‡</h3>
      <div class="upload-area">
        <label for="upload" class="upload-btn">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</label>
        <input id="upload" type="file" onchange="viewer()" accept="image/*">
        <button class="select-img-btn" id="selectImgBtn">é€‰æ‹©å›¾ç‰‡</button>
      </div>
    </div>

    <!-- åœ£è¯å¸½é€‰æ‹©åŒºåŸŸ -->
    <div class="section">
      <h3 class="section-title">é€‰æ‹©ä¸€é¡¶åœ£è¯å¸½ï¼ˆå·¦å³æ»‘åŠ¨ï¼‰</h3>
      <div class="hat-list" id="hatList">
        <!-- å¸½å­é€‰é¡¹ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ç”»å¸ƒåŒºåŸŸ -->
    <div class="canvas-wrap" id="canvasWrap">
      <canvas id="cvs"></canvas>
      <p id="tip">ç‚¹å‡»å¸½å­è°ƒæ•´ä½ç½®å’Œå¤§å° ğŸ…</p>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="section">
      <h3 class="section-title">åˆ¶ä½œå®Œæˆäº†å°±ä¸‹è½½å§</h3>
      <div class="btn-group">
        <button class="btn change-btn" id="changeBtn" style="display:none;">æ¢ ä¸€ é¡¶</button>
        <button class="btn export-btn" id="exportBtn" style="display:none;" onclick="exportFunc()">ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>

    <!-- å¯¼å‡ºå›¾ç‰‡å±•ç¤ºï¼ˆé»˜è®¤éšè—ï¼Œæ”¹ä¸ºè‡ªåŠ¨ä¸‹è½½ï¼‰ -->
    <img id="export" alt="åœ£è¯å¤´åƒ" src="" />

    <!-- åº•éƒ¨æç¤º -->
    <div class="footer-tip">
      æœ¬ç«™è‡ª2025å¹´12æœˆ7æ—¥å‚æ™šå¼€å§‹æµé‡æš´æ¶¨ï¼Œåšä¸»å·²ç»å¯¹æœåŠ¡å™¨è¿›è¡Œäº†ä¸€æ¬¡ç´§æ€¥æ‰©å®¹ï¼Œ<br>
      å¦‚æœä½ æ„Ÿåˆ°è®¿é—®é€Ÿåº¦ç¼“æ…¢ï¼Œæ•¬è¯·è°…è§£~<br>
      <a href="http://wpa.qq.com/msgrd?v=3&uin=1612704618&site=qq&menu=yes" target="_blank" class="footer-link">ç‚¹å‡»è¿™é‡Œè”ç³»æˆ‘</a> | 
      <a href="http://wpa.qq.com/msgrd?v=3&uin=1612704618&site=qq&menu=yes" target="_blank" class="footer-link">è®¿é—®æˆ‘çš„åšå®¢</a>
    </div>
  </div>

  <!-- éšè—çš„å›¾ç‰‡èµ„æº -->
  <div style="display: none;">
    <img id="avatarImg" src="" alt="ç”¨æˆ·å¤´åƒ" />
    <img class="hat-res" src="hats_images/0.png" alt="åœ£è¯å¸½1" data-hat-index="0" />
    <img class="hat-res" src="hats_images/1.png" alt="åœ£è¯å¸½2" data-hat-index="1" />
    <img class="hat-res" src="hats_images/2.png" alt="åœ£è¯å¸½3" data-hat-index="2" />
    <img class="hat-res" src="hats_images/3.png" alt="åœ£è¯å¸½4" data-hat-index="3" />
    <img class="hat-res" src="hats_images/4.png" alt="åœ£è¯å¸½5" data-hat-index="4" />
    <img class="hat-res" src="hats_images/5.png" alt="åœ£è¯å¸½6" data-hat-index="5" />
    <img class="hat-res" src="hats_images/6.png" alt="åœ£è¯å¸½7" data-hat-index="6" />
    <img class="hat-res" src="hats_images/7.png" alt="åœ£è¯å¸½8" data-hat-index="7" />
    <img class="hat-res" src="hats_images/8.png" alt="åœ£è¯å¸½9" data-hat-index="8" />
    <img class="hat-res" src="hats_images/9.png" alt="åœ£è¯å¸½10" data-hat-index="9" />
  </div>

<script src="fabric.min.js"></script>
<script>
  // åˆå§‹åŒ–å˜é‡
  const cvs = document.getElementById("cvs");
  const exportImage = document.getElementById("export");
  const avatarImg = document.getElementById("avatarImg");
  const hatListEl = document.getElementById("hatList");
  const canvasWrap = document.getElementById("canvasWrap");
  const changeBtn = document.getElementById("changeBtn");
  const exportBtn = document.getElementById("exportBtn");
  const selectImgBtn = document.getElementById("selectImgBtn");
  
  let canvasFabric;
  let hatInstance;
  let currentHatIndex = 0;
  let validHatList = [];
  const hatResList = document.getElementsByClassName("hat-res");
  const screenWidth = Math.min(window.screen.width - 40, 350);

  // é¢„åŠ è½½å¸½å­
  function preloadHats() {
    return new Promise((resolve) => {
      let loadedCount = 0;
      const total = hatResList.length;

      Array.from(hatResList).forEach((hat, index) => {
        hat.onload = () => {
          validHatList.push({ src: hat.src, index: index });
          loadedCount++;
          checkAllLoaded();
        };
        hat.onerror = () => {
          console.warn(`å¸½å­åŠ è½½å¤±è´¥ï¼š${hat.src}`);
          loadedCount++;
          checkAllLoaded();
        };
        if (hat.complete) hat.onload();
      });

      function checkAllLoaded() {
        if (loadedCount === total) resolve();
      }
    });
  }

  // æ¸²æŸ“å¸½å­åˆ—è¡¨
  async function renderHatList() {
    hatListEl.innerHTML = "";
    await preloadHats();

    if (validHatList.length === 0) {
      hatListEl.innerHTML = `<div style="padding:20px;color:#999;">æ²¡æœ‰å¯ç”¨çš„åœ£è¯å¸½å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ hats_images ç›®å½•</div>`;
      return;
    }

    validHatList.forEach((hat, listIndex) => {
      const item = document.createElement("div");
      item.className = `hat-item ${listIndex === currentHatIndex ? 'active' : ''}`;
      item.dataset.listIndex = listIndex;

      const imgEl = document.createElement("img");
      imgEl.src = hat.src;
      imgEl.alt = `åœ£è¯å¸½${hat.index+1}`;
      imgEl.onerror = () => item.innerHTML = `<span class="hat-loading">åŠ è½½å¤±è´¥</span>`;

      item.appendChild(imgEl);
      item.onclick = () => {
        currentHatIndex = listIndex;
        changeHat();
        document.querySelectorAll('.hat-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      };
      hatListEl.appendChild(item);
    });
  }

  // é¡µé¢åŠ è½½åˆå§‹åŒ–
  window.onload = () => {
    renderHatList();
    // æ¢ä¸€é¡¶æŒ‰é’®äº‹ä»¶
    changeBtn.onclick = () => {
      if (validHatList.length === 0) return;
      currentHatIndex = (currentHatIndex + 1) % validHatList.length;
      document.querySelectorAll('.hat-item').forEach((item, index) => {
        item.classList.toggle('active', index === currentHatIndex);
      });
      changeHat();
    };
  };

  // é€‰æ‹©å›¾ç‰‡æŒ‰é’®
  selectImgBtn.onclick = () => document.getElementById("upload").click();

  // ä¸Šä¼ å¤´åƒ
  function viewer() {
    const file = document.getElementById("upload").files[0];
    if (!file) return;
    if (file.type.split('/')[0] !== 'image') {
      alert("è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼æ–‡ä»¶ï¼");
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      avatarImg.src = e.target.result;
      avatarImg.onload = initCanvas;
    };
  }

// æ›¿æ¢åŸinitCanvaså‡½æ•°
function initCanvas() {
  if (validHatList.length === 0) {
    alert("æ²¡æœ‰å¯ç”¨çš„åœ£è¯å¸½ï¼Œè¯·æ£€æŸ¥ hats_images ç›®å½•ï¼");
    return;
  }

  // 1. è®¡ç®—å›¾ç‰‡çš„æ­£ç¡®ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
  const imgRatio = avatarImg.width / avatarImg.height; // åŸå›¾å®½é«˜æ¯”
  let canvasWidth, canvasHeight;

  // 2. æ ¹æ®å›¾ç‰‡æ¯”ä¾‹è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆæœ€å¤§ä¸è¶…è¿‡screenWidthï¼‰
  if (imgRatio >= 1) {
    // æ¨ªå›¾ï¼šå®½ä¸ºscreenWidthï¼Œé«˜æŒ‰æ¯”ä¾‹è®¡ç®—
    canvasWidth = screenWidth;
    canvasHeight = screenWidth / imgRatio;
  } else {
    // ç«–å›¾ï¼šé«˜ä¸ºscreenWidthï¼Œå®½æŒ‰æ¯”ä¾‹è®¡ç®—
    canvasHeight = screenWidth;
    canvasWidth = screenWidth * imgRatio;
  }

  // 3. è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆéæ­£æ–¹å½¢ï¼Œé€‚åº”å›¾ç‰‡æ¯”ä¾‹ï¼‰
  cvs.width = canvasWidth;
  cvs.height = canvasHeight;
  canvasWrap.style.display = "block";

  // 4. åˆå§‹åŒ–ç”»å¸ƒ
  canvasFabric = new fabric.Canvas("cvs", {
    width: canvasWidth,
    height: canvasHeight,
    selection: false
  });

  // 5. æ·»åŠ èƒŒæ™¯å›¾ï¼ˆæŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œå±…ä¸­æ˜¾ç¤ºï¼Œä¸æ‹‰ä¼¸ï¼‰
  const bgImg = new fabric.Image(avatarImg, {
    scaleX: canvasWidth / avatarImg.width, // ç­‰æ¯”ä¾‹ç¼©æ”¾
    scaleY: canvasHeight / avatarImg.height,
    originX: 'center',
    originY: 'center',
    left: canvasWidth / 2, // æ°´å¹³å±…ä¸­
    top: canvasHeight / 2  // å‚ç›´å±…ä¸­
  });
  canvasFabric.setBackgroundImage(bgImg, canvasFabric.renderAll.bind(canvasFabric));

  // 6. æ˜¾ç¤ºæŒ‰é’®å¹¶åŠ è½½å¸½å­
  changeBtn.style.display = "inline-block";
  exportBtn.style.display = "inline-block";
  changeHat();
}

  // åˆ‡æ¢å¸½å­ï¼ˆç¡®ä¿æ°´å¹³å±…ä¸­ï¼‰
  function changeHat() {
    if (hatInstance) canvasFabric.remove(hatInstance);
    const currentHat = validHatList[currentHatIndex];
    if (!currentHat) return;

    const hatImg = new Image();
    hatImg.src = currentHat.src;

    hatImg.onload = () => {
      const avatarScale = screenWidth / avatarImg.width;
      const hatScale = 120 / hatImg.width;
      const hatInitTop = (avatarImg.height * avatarScale) * 0.1; // é¡¶éƒ¨ä½ç½®

      // æ ¸å¿ƒï¼šå¸½å­æ°´å¹³å±…ä¸­ï¼ˆåŸºäºç”»å¸ƒä¸­å¿ƒç‚¹ï¼‰
      hatInstance = new fabric.Image(hatImg, {
        top: hatInitTop,
        left: screenWidth / 2, // ç”»å¸ƒæ°´å¹³ä¸­ç‚¹
        originX: 'center', // å¸½å­è‡ªèº«ä¸­å¿ƒç‚¹å¯¹é½ç”»å¸ƒä¸­ç‚¹
        originY: 'top', // å¸½å­é¡¶éƒ¨å¯¹é½è®¡ç®—ä½ç½®
        scaleX: hatScale,
        scaleY: hatScale,
        cornerColor: "#ff9900",
        cornerStrokeColor: "#fff",
        cornerStyle: "circle",
        transparentCorners: false,
        hasRotatingPoint: false,
        borderColor: "#ff9900",
        borderScaleFactor: 1.2
      });

      // éšè—å¤šä½™æ§åˆ¶æŸ„
      hatInstance.setControlVisible({
        bl: false, tr: false, tl: false, mr: false, mt: false, ml: false, mb: false
      });

      canvasFabric.add(hatInstance);
      canvasFabric.setActiveObject(hatInstance);
    };

    hatImg.onerror = () => {
      alert(`å¸½å­åŠ è½½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¡¶`);
      currentHatIndex = (currentHatIndex + 1) % validHatList.length;
      document.querySelectorAll('.hat-item').forEach((item, index) => {
        item.classList.toggle('active', index === currentHatIndex);
      });
      changeHat();
    };
  }

// åŒæ­¥ä¿®æ”¹å¯¼å‡ºå‡½æ•°ï¼Œä¿æŒæ¯”ä¾‹
function exportFunc() {
  if (!canvasFabric || !hatInstance) return;

  // ç›´æ¥å¯¼å‡ºç”»å¸ƒå®Œæ•´å†…å®¹ï¼ˆä¿æŒåŸæ¯”ä¾‹ï¼Œä¸æ‹‰ä¼¸ï¼‰
  canvasFabric.contextContainer.imageSmoothingEnabled = false;
  canvasFabric.contextTop.imageSmoothingEnabled = false;
  
  const dataURL = canvasFabric.toDataURL({
    format: 'png',
    quality: 1.0,
    multiplier: 2 // é«˜æ¸…å¯¼å‡º
  });

  // åç»­ä¸‹è½½é€»è¾‘ä¸å˜...
  try {
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `åœ£è¯å¤´åƒ_${new Date().getTime()}.png`;
    document.body.appendChild(a);
    const event = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
    a.dispatchEvent(event);
    document.body.removeChild(a);
    alert("å›¾ç‰‡å·²å¼€å§‹ä¸‹è½½ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ï¼");
  } catch (e) {
    const exportImg = document.getElementById('export');
    exportImg.src = dataURL;
    exportImg.style.display = 'block';
    canvasWrap.style.display = 'none';
    changeBtn.style.display = 'none';
    exportBtn.style.display = 'none';
    document.getElementById('tip').innerHTML = 'å³é”®å›¾ç‰‡ -> å¦å­˜ä¸º ä¿å­˜å›¾ç‰‡ ğŸ“Œ';
    document.getElementById('tip').style.color = '#ffcc66';
  }
}

  // çª—å£ resize å¤„ç†
  window.onresize = () => {
    if (canvasFabric) {
      const newWidth = Math.min(window.screen.width - 40, 350);
      if (newWidth !== screenWidth) location.reload();
    }
  };
</script>
</body>
</html>